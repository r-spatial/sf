<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
<ol style="list-style-type: decimal">
<li>Simple Features for R</li>
</ol> • sf</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sf</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/edzer/sfr/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1><ol style="list-style-type: decimal">
<li>Simple Features for R</li>
</ol></h1>
            
          </div>

    
    
<div class="contents">
<p><a href="https://en.wikipedia.org/wiki/Simple_Features">Simple features</a> or <a href="http://www.opengeospatial.org/standards/sfa"><em>simple feature access</em></a> refers to a formal standard (ISO 19125-1:2004) that describes how objects in the real world can be represented in computers, with emphasis on the <em>spatial</em> geometry of these objects. It also describes how such objects can be stored in and retrieved from databases, and which geometrical operations should be defined for them.</p>
<p>The standard is widely implemented in spatial databases (such as PostGIS), commercial GIS (e.g., <a href="http://www.esri.com/">ESRI ArcGIS</a>) and forms the vector data basis for libraries such as <a href="http://www.gdal.org/">GDAL</a>. A subset of simple features forms the <a href="http://geojson.org/">GeoJSON</a> standard.</p>
<p>R has well-supported classes for storing spatial data (<a href="https://CRAN.R-project.org/package=sp">sp</a>) and interfacing to the above mentioned environments (<a href="https://CRAN.R-project.org/package=rgdal">rgdal</a>, <a href="https://CRAN.R-project.org/package=rgeos">rgeos</a>), but has so far lacked a complete implementation of simple features, making conversions at times convoluted, inefficient or incomplete. The package <a href="http://github.com/edzer/sfr">sf</a> tries to fill this gap, and aims at succeeding <a href="https://CRAN.R-project.org/package=sp">sp</a> in the long term.</p>
<p>This vignette:</p>
<ul>
<li>explains what is meant by features, and by simple features</li>
<li>shows how they are implemented in R</li>
<li>provides examples of how you can work with them</li>
<li>shows how they can be read from and written to external files or resources</li>
<li>discusses how they can be converted to and from sp objects</li>
<li>shows how they can be used for meaningful spatial analysis</li>
</ul>
<div id="what-is-a-feature" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is-a-feature" class="anchor"></a>What is a feature?</h1>
<p>A feature is thought of as a thing, or an object in the real world, such as a building or a tree. As is the case with objects, they often consist of other objects. This is the case with features too: a set of features can form a single feature. A forest stand can be a feature, a forest can be a feature, a city can be a feature. A satellite image pixel can be a feature, a complete image can be a feature too.</p>
<p>Features have a <em>geometry</em> describing <em>where</em> on Earth the feature is located, and they have attributes, which describe other properties. The geometry of a tree can be the delineation of its crown, of its stem, or the point indicating its centre. Other properties may include its height, color, diameter at breast height at a particular date, and so on.</p>
<p>The standard says: “<em>A simple feature is defined by the OpenGIS Abstract specification to have both spatial and non-spatial attributes. Spatial attributes are geometry valued, and simple features are based on 2D geometry with linear interpolation between vertices.</em>” We will see soon that the same standard will extend its coverage beyond 2D and beyond linear interpolation. Here, we take simple features as the data structures and operations described in the <a href="http://www.opengeospatial.org/standards/sfa">standard</a>.</p>
<div id="dimensions" class="section level2">
<h2 class="hasAnchor">
<a href="#dimensions" class="anchor"></a>Dimensions</h2>
<p>All geometries are composed of points. Points are coordinates in a 2-, 3- or 4-dimensional space. All points in a geometry have the same dimensionality. In addition to X and Y coordinates, there are two optional additional dimensions:</p>
<ul>
<li>a Z coordinate, denoting altitude</li>
<li>an M coordinate (rarely used), denoting some <em>measure</em> that is associated with the point, rather than with the feature as a whole (in which case it would be a feature attribute); examples could be time of measurement, or measurement error of the coordinates</li>
</ul>
<p>The four possible cases then are:</p>
<ol style="list-style-type: decimal">
<li>two-dimensional points refer to x and y, easting and northing, or longitude and latitude, we refer to them as XY</li>
<li>three-dimensional points as XYZ</li>
<li>three-dimensional points as XYM</li>
<li>four-dimensional points as XYZM (the third axis is Z, fourth M)</li>
</ol>
</div>
<div id="simple-feature-geometry-types" class="section level2">
<h2 class="hasAnchor">
<a href="#simple-feature-geometry-types" class="anchor"></a>Simple feature geometry types</h2>
<p>The following seven simple feature types are the most common, and are for instance the only ones used for <a href="https://tools.ietf.org/html/rfc7946">GeoJSON</a>:</p>
<table style="width:78%;" class="table">
<colgroup>
<col width="6%">
<col width="70%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>POINT</code></td>
<td align="left">zero-dimensional geometry containing a single point</td>
</tr>
<tr class="even">
<td align="left"><code>LINESTRING</code></td>
<td align="left">sequence of points connected by straight, non-self intersecting line pieces; one-dimensional geometry</td>
</tr>
<tr class="odd">
<td align="left"><code>POLYGON</code></td>
<td align="left">geometry with a positive area (two-dimensional); sequence of points form a closed, non-self intersecting ring; the first ring denotes the exterior ring, zero or more subsequent rings denote holes in this exterior ring</td>
</tr>
<tr class="even">
<td align="left"><code>MULTIPOINT</code></td>
<td align="left">set of points; a MULTIPOINT is simple if no two Points in the MULTIPOINT are equal</td>
</tr>
<tr class="odd">
<td align="left"><code>MULTILINESTRING</code></td>
<td align="left">set of linestrings</td>
</tr>
<tr class="even">
<td align="left"><code>MULTIPOLYGON</code></td>
<td align="left">set of polygons</td>
</tr>
<tr class="odd">
<td align="left"><code>GEOMETRYCOLLECTION</code></td>
<td align="left">set of geometries of any type except GEOMETRYCOLLECTION</td>
</tr>
</tbody>
</table>
<p>Each of the geometry types can also be a (typed) empty set, containing zero coordinates (for <code>POINT</code> the standard is not clear how to represent the empty geometry). Empty geometries can be thought of being the analogue to missing (<code>NA</code>) attributes, NULL values or empty lists.</p>
<p>The remaining geometries 10 are more rare, but increasingly find implementations:</p>
<table style="width:78%;" class="table">
<colgroup>
<col width="6%">
<col width="70%">
</colgroup>
<thead><tr class="header">
<th align="left">type</th>
<th align="left">description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>CIRCULARSTRING</code></td>
<td align="left">The CIRCULARSTRING is the basic curve type, similar to a LINESTRING in the linear world. A single segment requires three points, the start and end points (first and third) and any other point on the arc. The exception to this is for a closed circle, where the start and end points are the same. In this case the second point MUST be the center of the arc, ie the opposite side of the circle. To chain arcs together, the last point of the previous arc becomes the first point of the next arc, just like in LINESTRING. This means that a valid circular string must have an odd number of points greated than 1.</td>
</tr>
<tr class="even">
<td align="left"><code>COMPOUNDCURVE</code></td>
<td align="left">A compound curve is a single, continuous curve that has both curved (circular) segments and linear segments. That means that in addition to having well-formed components, the end point of every component (except the last) must be coincident with the start point of the following component.</td>
</tr>
<tr class="odd">
<td align="left"><code>CURVEPOLYGON</code></td>
<td align="left">Example compound curve in a curve polygon: CURVEPOLYGON(COMPOUNDCURVE(CIRCULARSTRING(0 0,2 0, 2 1, 2 3, 4 3),(4 3, 4 5, 1 4, 0 0)), CIRCULARSTRING(1.7 1, 1.4 0.4, 1.6 0.4, 1.6 0.5, 1.7 1) )</td>
</tr>
<tr class="even">
<td align="left"><code>MULTICURVE</code></td>
<td align="left">A MultiCurve is a 1-dimensional GeometryCollection whose elements are Curves, it can include linear strings, circular strings or compound strings.</td>
</tr>
<tr class="odd">
<td align="left"><code>MULTISURFACE</code></td>
<td align="left">A MultiSurface is a 2-dimensional GeometryCollection whose elements are Surfaces, all using coordinates from the same coordinate reference system.</td>
</tr>
<tr class="even">
<td align="left"><code>CURVE</code></td>
<td align="left">A Curve is a 1-dimensional geometric object usually stored as a sequence of Points, with the subtype of Curve specifying the form of the interpolation between Points</td>
</tr>
<tr class="odd">
<td align="left"><code>SURFACE</code></td>
<td align="left">A Surface is a 2-dimensional geometric object</td>
</tr>
<tr class="even">
<td align="left"><code>POLYHEDRALSURFACE</code></td>
<td align="left">A PolyhedralSurface is a contiguous collection of polygons, which share common boundary segments</td>
</tr>
<tr class="odd">
<td align="left"><code>TIN</code></td>
<td align="left">A TIN (triangulated irregular network) is a PolyhedralSurface consisting only of Triangle patches.</td>
</tr>
<tr class="even">
<td align="left"><code>TRIANGLE</code></td>
<td align="left">A Triangle is a polygon with 3 distinct, non-collinear vertices and no interior boundary</td>
</tr>
</tbody>
</table>
<p>Note that <code>CIRCULASTRING</code>, <code>COMPOUNDCURVE</code> and <code>CURVEPOLYGON</code> are not described in the SFA standard, but in the <a href="https://www.iso.org/standard/38651.html">SQL-MM part 3 standard</a>. The descriptions above were copied from the <a href="http://postgis.net/docs/using_postgis_dbmanagement.html">PostGIS manual</a>.</p>
</div>
<div id="coordinate-reference-system" class="section level2">
<h2 class="hasAnchor">
<a href="#coordinate-reference-system" class="anchor"></a>Coordinate reference system</h2>
<p>Coordinates can only be placed on the Earth’s surface when their coordinate reference system (CRS) is known; this may be an elipsoidal CRS such as WGS84, a projected, two-dimensional (Cartesian) CRS such as a UTM zone or Web Mercator, or a CRS in three-dimensions or <a href="http://www.faculty.jacobs-university.de/pbaumann/iu-bremen.de_pbaumann/Papers/acmgis-2012_crs-nts.pdf">including time</a>. Similarly, M-coordinates need an attribute reference system, e.g. a <a href="https://CRAN.R-project.org/package=units">measurement unit</a>.</p>
</div>
</div>
<div id="how-simple-features-in-r-are-organized" class="section level1">
<h1 class="hasAnchor">
<a href="#how-simple-features-in-r-are-organized" class="anchor"></a>How simple features in R are organized</h1>
<p>Package <code>sf</code> represents simple features as native R objects. Similar to <a href="http://postgis.net/">PostGIS</a>, all functions and methods in <code>sf</code> that operate on spatial data are prefixed by <code>st_</code>, which refers to <em>spatial and temporal</em>; this makes them easily findable by command-line completion. Simple features are implemented as R native data, using simple data structures (S3 classes, lists, matrix, vector). Typical use involves reading, manipulating and writing of sets of features, with attributes and geometries.</p>
<p>As attributes are typically stored in <code>data.frame</code> objects (or the very similar <code>tbl_df</code>), we will also store feature geometries in a <code>data.frame</code> column. Since geometries are not single-valued, they are put in a list-column, a list of length equal to the number of records in the <code>data.frame</code>, with each list element holding the simple feature geometry of that feature. The three classes used to represent simple features are:</p>
<ul>
<li>
<code>sf</code>, the table (<code>data.frame</code>) with feature attributes and feature geometries, which contains</li>
<li>
<code>sfc</code>, the list-column with the geometries for each feature (record), which is composed of</li>
<li>
<code>sfg</code>, the feature geometry of an individual simple feature.</li>
</ul>
<p>We will now discuss each of these three classes.</p>
<div id="sf-objects-with-simple-features" class="section level2">
<h2 class="hasAnchor">
<a href="#sf-objects-with-simple-features" class="anchor"></a>sf: objects with simple features</h2>
<p>As we usually do not work with geometries of single simple features, but with datasets consisting of sets of features with attributes, the two are put together in <code>sf</code> (simple feature) objects. The following command reads the <code>nc</code> dataset from a file that is contained in the <code>sf</code> package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
## Linking to GEOS 3.5.1, GDAL 2.1.3, proj.4 4.9.2, lwgeom 2.3.2 r15302
nc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="kw">system.file</span>(<span class="st">"shape/nc.shp"</span>, <span class="dt">package=</span><span class="st">"sf"</span>))
## Reading layer `nc' from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/3.4/sf/shape/nc.shp' using driver `ESRI Shapefile'
## converted into: POLYGON
## Simple feature collection with 100 features and 14 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## epsg (SRID):    4267
## proj4string:    +proj=longlat +datum=NAD27 +no_defs</code></pre></div>
<p>(Note that users will not use <code>system.file</code> but give a <code>filename</code> directly, and that shapefiles consist of more than one file, all with identical basename, which reside in the same directory.) The short report printed gives the file name, the driver (ESRI Shapefile), mentions that there are 100 features (records, represented as rows) and 14 fields (attributes, represented as columns). This object is of class</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(nc)
## [1] "sf"         "data.frame"</code></pre></div>
<p>meaning it extends (and “is” a) <code>data.frame</code>, but with a single list-column with geometries, which is held in the column with name</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">attr</span>(nc, <span class="st">"sf_column"</span>)
## [1] "geometry"</code></pre></div>
<p>If we print the first three features, we see their attribute values and an abridged version of the geometry</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(nc[<span class="dv">9</span>:<span class="dv">15</span>], <span class="dt">n =</span> <span class="dv">3</span>)</code></pre></div>
<p>which would give the following output:</p>
<div class="figure">
<img src="sf_xfig.png">
</div>
<p>In the output we see:</p>
<ul>
<li>in green a simple feature: a single record, or <code>data.frame</code> row, consisting of attributes and geometry</li>
<li>in blue a single simple feature geometry (an object of class <code>sfg</code>)</li>
<li>in red a simple feature list-column (an object of class <code>sfc</code>, which is a column in the <code>data.frame</code>)</li>
<li>that although geometries are native R objects, they are printed as <a href="#wkb">well-known text</a>
</li>
</ul>
<p>Methods for <code>sf</code> objects are</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">"sf"</span>)
##  [1] aggregate         cbind             coerce           
##  [4] initialize        merge             plot             
##  [7] print             rbind             [                
## [10] [[&lt;-              $&lt;-               show             
## [13] slotsFromS3       st_agr&lt;-          st_agr           
## [16] st_as_sf          st_bbox           st_boundary      
## [19] st_buffer         st_cast           st_centroid      
## [22] st_convex_hull    st_coordinates    st_crs&lt;-         
## [25] st_crs            st_difference     st_geometry&lt;-    
## [28] st_geometry       st_intersection   st_is            
## [31] st_line_merge     st_make_valid     st_polygonize    
## [34] st_precision      st_segmentize     st_set_precision 
## [37] st_simplify       st_sym_difference st_transform     
## [40] st_triangulate    st_union          st_voronoi       
## [43] st_zm            
## see '?methods' for accessing help and source code</code></pre></div>
<p>It is also possible to create <code>data.frame</code> objects with geometry list-columns that are not of class <code>sf</code>, e.g. by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc.no_sf &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(nc)
<span class="kw">class</span>(nc.no_sf)
## [1] "data.frame"</code></pre></div>
<p>However, such objects:</p>
<ul>
<li>no longer register which column is the geometry list-column</li>
<li>no longer have a plot method, and</li>
<li>lack all of the other dedicated methods listed above for class <code>sf</code>
</li>
</ul>
</div>
<div id="sfc-simple-feature-geometry-list-column" class="section level2">
<h2 class="hasAnchor">
<a href="#sfc-simple-feature-geometry-list-column" class="anchor"></a>sfc: simple feature geometry list-column</h2>
<p>The column in the <code>sf</code> data.frame that contains the geometries is a list, of class <code>sfc</code>. We can retrieve the geometry list-column in this case by <code>nc$geom</code> or <code>nc[[15]]</code>, but the more general way uses <code>st_geometry</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(nc_geom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_geometry.html">st_geometry</a></span>(nc))
## Geometry set for 100 features 
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## epsg (SRID):    4267
## proj4string:    +proj=longlat +datum=NAD27 +no_defs
## First 5 geometries:
## MULTIPOLYGON(((-81.4727554321289 36.23435592651...
## MULTIPOLYGON(((-81.2398910522461 36.36536407470...
## MULTIPOLYGON(((-80.4563446044922 36.24255752563...
## MULTIPOLYGON(((-76.0089721679688 36.31959533691...
## MULTIPOLYGON(((-77.2176666259766 36.24098205566...</code></pre></div>
<p>Geometries are printed in abbreviated form, but we can can view a complete geometry by selecting it, e.g. the first one by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc_geom[[<span class="dv">1</span>]]
## MULTIPOLYGON(((-81.4727554321289 36.2343559265137, -81.5408401489258 36.2725067138672, -81.5619812011719 36.2735939025879, -81.6330642700195 36.3406867980957, -81.7410736083984 36.3917846679688, -81.6982803344727 36.4717788696289, -81.7027969360352 36.5193405151367, -81.6699981689453 36.5896492004395, -81.3452987670898 36.5728645324707, -81.347541809082 36.537914276123, -81.3247756958008 36.5136795043945, -81.3133239746094 36.4806976318359, -81.2662353515625 36.4372062683105, -81.2628402709961 36.4050407409668, -81.2406921386719 36.3794174194336, -81.2398910522461 36.365364074707, -81.2642440795898 36.3524131774902, -81.3289947509766 36.3635025024414, -81.3613739013672 36.3531608581543, -81.3656921386719 36.3390502929688, -81.354133605957 36.2997169494629, -81.3674545288086 36.2786979675293, -81.4063873291016 36.2850532531738, -81.4123306274414 36.2672920227051, -81.431037902832 36.2607192993164, -81.4528884887695 36.2395858764648, -81.4727554321289 36.2343559265137)))</code></pre></div>
<p>The way this is printed is called <em>well-known text</em>, and is part of the standards. The word <code>MULTIPOLYGON</code> is followed by three parenthesis, because it can consist of multiple polygons, in the form of <code>MULTIPOLYGON(POL1,POL2)</code>, where <code>POL1</code> might consist of an exterior ring and zero or more interior rings, as of <code>(EXT1,HOLE1,HOLE2)</code>. Sets of coordinates are held together with parenthesis, so we get <code>((crds_ext)(crds_hole1)(crds_hole2))</code> where <code>crds_</code> is a comma-separated set of coordinates of a ring. This leads to the case above, where <code>MULTIPOLYGON(((crds_ext)))</code> refers to the exterior ring (1), without holes (2), of the first polygon (3) - hence three parentheses.</p>
<p>We can see there is a single polygon with no rings:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))
<span class="kw"><a href="../reference/plot.html">plot</a></span>(nc[<span class="dv">1</span>])
<span class="kw"><a href="../reference/plot.html">plot</a></span>(nc[<span class="dv">1</span>,<span class="dv">1</span>], <span class="dt">col =</span> <span class="st">'grey'</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>but some of the polygons in this dataset have multiple exterior rings; they can be identified by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))
(w &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">sapply</span>(nc_geom, length) &gt;<span class="st"> </span><span class="dv">1</span>))
## [1]  4 56 57 87 91 95
<span class="kw"><a href="../reference/plot.html">plot</a></span>(nc[w,<span class="dv">1</span>], <span class="dt">col =</span> <span class="dv">2</span>:<span class="dv">7</span>)</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<p>Following the <code>MULTIPOLYGON</code> datastructure, in R we have a list of lists of lists of matrices. For instance, we get the first 3 coordinate pairs of the second exterior ring (first ring is always exterior) for the geometry of feature 4 by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc_geom[[<span class="dv">4</span>]][[<span class="dv">2</span>]][[<span class="dv">1</span>]][<span class="dv">1</span>:<span class="dv">3</span>,]
##           [,1]     [,2]
## [1,] -76.02717 36.55672
## [2,] -75.99866 36.55665
## [3,] -75.91192 36.54253</code></pre></div>
<p>Geometry columns have their own class,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">class</span>(nc_geom)
## [1] "sfc_MULTIPOLYGON" "sfc"</code></pre></div>
<p>Methods for geometry list-columns include</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">methods</span>(<span class="dt">class =</span> <span class="st">'sfc'</span>)
##  [1] as.data.frame     coerce            c                
##  [4] format            initialize        Ops              
##  [7] print             [                 show             
## [10] slotsFromS3       st_as_binary      st_as_text       
## [13] st_bbox           st_boundary       st_buffer        
## [16] st_cast           st_centroid       st_convex_hull   
## [19] st_coordinates    st_crs&lt;-          st_crs           
## [22] st_difference     st_geometry       st_intersection  
## [25] st_is             st_line_merge     st_make_valid    
## [28] st_polygonize     st_precision      str              
## [31] st_segmentize     st_set_precision  st_simplify      
## [34] st_sym_difference st_transform      st_triangulate   
## [37] st_union          st_voronoi        st_zm            
## [40] summary          
## see '?methods' for accessing help and source code</code></pre></div>
<p>Coordinate reference systems (<code>st_crs</code> and <code>st_transform</code>) are discussed in the section on <a href="#crs">coordinate reference systems</a>. <code>st_as_wkb</code> and <code>st_as_text</code> convert geometry list-columns into well-known-binary or well-known-text, explained <a href="#wkb">below</a>. <code>st_bbox</code> retrieves the coordinate bounding box.</p>
<p>Attributes include</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">attributes</span>(nc_geom)
## $n_empty
## [1] 0
## 
## $crs
## $epsg
## [1] 4267
## 
## $proj4string
## [1] "+proj=longlat +datum=NAD27 +no_defs"
## 
## attr(,"class")
## [1] "crs"
## 
## $class
## [1] "sfc_MULTIPOLYGON" "sfc"             
## 
## $precision
## [1] 0
## 
## $bbox
##      xmin      ymin      xmax      ymax 
## -84.32385  33.88199 -75.45698  36.58965</code></pre></div>
</div>
<div id="mixed-geometry-types" class="section level2">
<h2 class="hasAnchor">
<a href="#mixed-geometry-types" class="anchor"></a>Mixed geometry types</h2>
<p>The class of <code>nc_geom</code> is <code>c("sfc_MULTIPOLYGON", "sfc")</code>: <code>sfc</code> is shared with all geometry types, and <code>sfc_TYPE</code> with <code>TYPE</code> indicating the type of the particular geometry at hand.</p>
<p>There are two “special” types: <code>GEOMETRYCOLLECTION</code>, and <code>GEOMETRY</code>. <code>GEOMETRYCOLLECTION</code> indicates that each of the geometries may contain a mix of geometry types, as in</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(mix &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sfc.html">st_sfc</a></span>(<span class="kw"><a href="../reference/st.html">st_geometrycollection</a></span>(<span class="kw">list</span>(<span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="dv">1</span>:<span class="dv">2</span>))), 
    <span class="kw"><a href="../reference/st.html">st_geometrycollection</a></span>(<span class="kw">list</span>(<span class="kw"><a href="../reference/st.html">st_linestring</a></span>(<span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">4</span>,<span class="dv">2</span>))))))
## Geometry set for 2 features 
## geometry type:  GEOMETRYCOLLECTION
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 2 ymax: 4
## epsg (SRID):    NA
## proj4string:    NA
## GEOMETRYCOLLECTION(POINT(1 2))
## GEOMETRYCOLLECTION(LINESTRING(1 3, 2 4))
<span class="kw">class</span>(mix)
## [1] "sfc_GEOMETRYCOLLECTION" "sfc"</code></pre></div>
<p>Still, the geometries are here of a single type.</p>
<p>The second <code>GEOMETRY</code>, indicates that the geometries in the geometry list-column are of varying type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(mix &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sfc.html">st_sfc</a></span>(<span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="dv">1</span>:<span class="dv">2</span>), <span class="kw"><a href="../reference/st.html">st_linestring</a></span>(<span class="kw">matrix</span>(<span class="dv">1</span>:<span class="dv">4</span>,<span class="dv">2</span>))))
## Geometry set for 2 features 
## geometry type:  GEOMETRY
## dimension:      XY
## bbox:           xmin: 1 ymin: 2 xmax: 2 ymax: 4
## epsg (SRID):    NA
## proj4string:    NA
## POINT(1 2)
## LINESTRING(1 3, 2 4)
<span class="kw">class</span>(mix)
## [1] "sfc_GEOMETRY" "sfc"</code></pre></div>
<p>These two are fundamentally different: <code>GEOMETRY</code> is a superclass without instances, <code>GEOMETRYCOLLECTION</code> is a geometry instance. <code>GEOMETRY</code> list-columns occur when we read in a data source with a mix of geometry types. <code>GEOMETRYCOLLECTION</code> <em>is</em> a single feature’s geometry: the intersection of two feature polygons may consist of points, lines and polygons, see the example <a href="#geometrycollection">below</a>.</p>
</div>
<div id="sfg-simple-feature-geometry" class="section level2">
<h2 class="hasAnchor">
<a href="#sfg-simple-feature-geometry" class="anchor"></a>sfg: simple feature geometry</h2>
<p>Simple feature geometry (<code>sfg</code>) objects carry the geometry for a single feature, e.g. a point, linestring or polygon.</p>
<p>Simple feature geometries are implemented as R native data, using the following rules</p>
<ol style="list-style-type: decimal">
<li>a single POINT is a numeric vector</li>
<li>a set of points, e.g. in a LINESTRING or ring of a POLYGON is a <code>matrix</code>, each row containing a point</li>
<li>any other set is a <code>list</code>
</li>
</ol>
<p>Creator functions are rarely used in practice, since we typically bulk read and write spatial data. They are useful for illustration:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)))
## POINT(1 2)
<span class="kw">str</span>(x)
## Classes 'XY', 'POINT', 'sfg'  num [1:2] 1 2
(x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>)))
## POINTZ(1 2 3)
<span class="kw">str</span>(x)
## Classes 'XYZ', 'POINT', 'sfg'  num [1:3] 1 2 3
(x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="st">"XYM"</span>))
## POINTM(1 2 3)
<span class="kw">str</span>(x)
## Classes 'XYM', 'POINT', 'sfg'  num [1:3] 1 2 3
(x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_point</a></span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>)))
## POINTZM(1 2 3 4)
<span class="kw">str</span>(x)
## Classes 'XYZM', 'POINT', 'sfg'  num [1:4] 1 2 3 4
<span class="kw"><a href="../reference/st_zm.html">st_zm</a></span>(x, <span class="dt">drop =</span> <span class="ot">TRUE</span>, <span class="dt">what =</span> <span class="st">"ZM"</span>)
## POINT(1 2)</code></pre></div>
<p>This means that we can represent 2-, 3- or 4-dimensional coordinates. All geometry objects inherit from <code>sfg</code> (simple feature geometry), but also have a type (e.g. <code>POINT</code>), and a dimension (e.g. <code>XYM</code>) class name. A figure illustrates six of the seven most common types.</p>
<p>With the exception of the <code>POINT</code> which has a single point as geometry, the remaining six common single simple feature geometry types that correspond to single features (single records, or rows in a <code>data.frame</code>) are created like this</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">3.2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="fl">4.6</span>), <span class="kw">c</span>(<span class="fl">3.8</span>,<span class="fl">4.4</span>), <span class="kw">c</span>(<span class="fl">3.5</span>,<span class="fl">3.8</span>), <span class="kw">c</span>(<span class="fl">3.4</span>,<span class="fl">3.6</span>), <span class="kw">c</span>(<span class="fl">3.9</span>,<span class="fl">4.5</span>))
(mp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_multipoint</a></span>(p))
## MULTIPOINT(3.2 4, 3 4.6, 3.8 4.4, 3.5 3.8, 3.4 3.6, 3.9 4.5)
s1 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">3</span>),<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span>),<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">5</span>))
(ls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_linestring</a></span>(s1))
## LINESTRING(0 3, 0 4, 1 5, 2 5)
s2 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">0.2</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="fl">0.2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="fl">4.8</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="fl">4.8</span>))
s3 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="fl">4.4</span>), <span class="kw">c</span>(<span class="fl">0.6</span>,<span class="dv">5</span>))
(mls &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_multilinestring</a></span>(<span class="kw">list</span>(s1,s2,s3)))
## MULTILINESTRING((0 3, 0 4, 1 5, 2 5), (0.2 3, 0.2 4, 1 4.8, 2 4.8), (0 4.4, 0.6 5))
p1 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>))
p2 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))
pol &lt;-<span class="kw"><a href="../reference/st.html">st_polygon</a></span>(<span class="kw">list</span>(p1,p2))
p3 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">0</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">1</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">0</span>))
p4 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="fl">3.3</span>,<span class="fl">0.3</span>), <span class="kw">c</span>(<span class="fl">3.8</span>,<span class="fl">0.3</span>), <span class="kw">c</span>(<span class="fl">3.8</span>,<span class="fl">0.8</span>), <span class="kw">c</span>(<span class="fl">3.3</span>,<span class="fl">0.8</span>), <span class="kw">c</span>(<span class="fl">3.3</span>,<span class="fl">0.3</span>))[<span class="dv">5</span>:<span class="dv">1</span>,]
p5 &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">2</span>), <span class="kw">c</span>(<span class="dv">4</span>,<span class="dv">3</span>), <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))
(mpol &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_multipolygon</a></span>(<span class="kw">list</span>(<span class="kw">list</span>(p1,p2), <span class="kw">list</span>(p3,p4), <span class="kw">list</span>(p5))))
## MULTIPOLYGON(((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3)))
(gc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_geometrycollection</a></span>(<span class="kw">list</span>(mp, mpol, ls)))
## GEOMETRYCOLLECTION(MULTIPOINT(3.2 4, 3 4.6, 3.8 4.4, 3.5 3.8, 3.4 3.6, 3.9 4.5), MULTIPOLYGON(((0 0, 1 0, 3 2, 2 4, 1 4, 0 0), (1 1, 1 2, 2 2, 1 1)), ((3 0, 4 0, 4 1, 3 1, 3 0), (3.3 0.3, 3.3 0.8, 3.8 0.8, 3.8 0.3, 3.3 0.3)), ((3 3, 4 2, 4 3, 3 3))), LINESTRING(0 3, 0 4, 1 5, 2 5))</code></pre></div>
<p>The objects created are shown here:</p>
<p><img src="sf1_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>Geometries can also be empty, as in</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_geometrycollection</a></span>())
## GEOMETRYCOLLECTION()
<span class="kw">length</span>(x)
## [1] 0</code></pre></div>
</div>
<div id="wkb" class="section level2">
<h2 class="hasAnchor">
<a href="#wkb" class="anchor"></a>Well-known text, well-known binary, precision</h2>
<div id="wkt-and-wkb" class="section level3">
<h3 class="hasAnchor">
<a href="#wkt-and-wkb" class="anchor"></a>WKT and WKB</h3>
<p>Well-known text (WKT) and well-known binary (WKB) are two encodings for simple feature geometries. Well-known text, e.g. seen in</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_linestring</a></span>(<span class="kw">matrix</span>(<span class="dv">10</span>:<span class="dv">1</span>,<span class="dv">5</span>))
<span class="kw"><a href="../reference/st_as_text.html">st_as_text</a></span>(x)
## [1] "LINESTRING(10 5, 9 4, 8 3, 7 2, 6 1)"</code></pre></div>
<p>(but without the leading <code>## [1]</code> and quotes), is human-readable. Coordinates are usually floating point numbers, and moving large amounts of information as text is slow and imprecise. For that reason, we use well-known binary (WKB) encoding</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_as_binary.html">st_as_binary</a></span>(x)
##  [1] 01 02 00 00 00 05 00 00 00 00 00 00 00 00 00 24 40 00 00 00 00 00 00
## [24] 14 40 00 00 00 00 00 00 22 40 00 00 00 00 00 00 10 40 00 00 00 00 00
## [47] 00 20 40 00 00 00 00 00 00 08 40 00 00 00 00 00 00 1c 40 00 00 00 00
## [70] 00 00 00 40 00 00 00 00 00 00 18 40 00 00 00 00 00 00 f0 3f</code></pre></div>
<p>WKT and WKB can both be transformed back into R native objects by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_as_sfc.html">st_as_sfc</a></span>(<span class="st">"LINESTRING(10 5, 9 4, 8 3, 7 2, 6 1)"</span>)[[<span class="dv">1</span>]]
## LINESTRING(10 5, 9 4, 8 3, 7 2, 6 1)
<span class="kw"><a href="../reference/st_as_sfc.html">st_as_sfc</a></span>(<span class="kw">structure</span>(<span class="kw">list</span>(<span class="kw"><a href="../reference/st_as_binary.html">st_as_binary</a></span>(x)), <span class="dt">class =</span> <span class="st">"WKB"</span>))[[<span class="dv">1</span>]]
## LINESTRING(10 5, 9 4, 8 3, 7 2, 6 1)</code></pre></div>
<p>GDAL, GEOS, spatial databases and GIS read and write WKB which is fast and precise. Conversion between R native objects and WKB is done by package <code>sf</code> in compiled (C++/Rcpp) code, making this a reusable and fast route for I/O of simple feature geometries in R.</p>
</div>
<div id="precision" class="section level3">
<h3 class="hasAnchor">
<a href="#precision" class="anchor"></a>Precision</h3>
<p>One of the attributes of a geometry list-column (<code>sfc</code>) is the <code>precision</code>: a double number that, when non-zero, causes some rounding during conversion to WKB, which might help certain geometrical operations succeed that would otherwise fail due to floating point representation. The model is that of GEOS, which copies from the Java Topology Suite (<a href="http://tsusiatsoftware.net/jts/main.html">JTS</a>), and works like this:</p>
<ul>
<li>if precision is zero (default, unspecified), nothing is modified</li>
<li>negative values convert to float (4-byte real) precision</li>
<li>positive values convert to <code>round(x*precision)/precision</code>.</li>
</ul>
<p>For the precion model, see also <a href="http://tsusiatsoftware.net/jts/javadoc/com/vividsolutions/jts/geom/PrecisionModel.html">here</a>, where it is written that: “… to specify 3 decimal places of precision, use a scale factor of 1000. To specify -3 decimal places of precision (i.e. rounding to the nearest 1000), use a scale factor of 0.001.” Note that all coordinates, so also <code>Z</code> or <code>M</code> values (if present) are affected. Choosing values for <code>precision</code> may require some experimenting.</p>
</div>
</div>
<div id="reading-and-writing" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-and-writing" class="anchor"></a>Reading and writing</h2>
<p>As we’ve seen above, reading spatial data from an external file can be done by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">filename &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"shape/nc.shp"</span>, <span class="dt">package=</span><span class="st">"sf"</span>)
nc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(filename)
## Reading layer `nc' from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/3.4/sf/shape/nc.shp' using driver `ESRI Shapefile'
## converted into: POLYGON
## Simple feature collection with 100 features and 14 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## epsg (SRID):    4267
## proj4string:    +proj=longlat +datum=NAD27 +no_defs</code></pre></div>
<p>we can suppress the output by adding argument <code>quiet=TRUE</code> or by using the otherwise nearly identical but more quiet</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">read_sf</a></span>(filename)</code></pre></div>
<p>Writing takes place in the same fashion, using <code>st_write</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_write.html">st_write</a></span>(nc, <span class="st">"nc.shp"</span>)
## Writing layer `nc' to data source `nc.shp' using driver `ESRI Shapefile'
## features:       100
## fields:         14
## geometry type:  Multi Polygon</code></pre></div>
<p>If we repeat this, we get an error message that the file already exists, and we can overwrite by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_write.html">st_write</a></span>(nc, <span class="st">"nc.shp"</span>, <span class="dt">delete_layer =</span> <span class="ot">TRUE</span>)
## Deleting layer `nc' using driver `ESRI Shapefile'
## Writing layer `nc' to data source `/home/edzer/git/sfr/docs/articles/nc.shp' using driver `ESRI Shapefile'
## features:       100
## fields:         14
## geometry type:  Multi Polygon</code></pre></div>
<p>or its quiet alternative that does this by default,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_write.html">write_sf</a></span>(nc, <span class="st">"nc.shp"</span>) <span class="co"># silently overwrites</span></code></pre></div>
<div id="driver-specific-options" class="section level3">
<h3 class="hasAnchor">
<a href="#driver-specific-options" class="anchor"></a>Driver-specific options</h3>
<p>The <code>dsn</code> and <code>layer</code> arguments to <code>st_read</code> and <code>st_write</code> denote a data source name and optionally a layer name. Their exact interpretation as well as the options they support vary per driver, the <a href="http://www.gdal.org/ogr_formats.html">GDAL driver documentation</a> is best consulted for this. For instance, a PostGIS table in database <code>postgis</code> might be read by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meuse &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"PG:dbname=postgis"</span>, <span class="st">"meuse"</span>)</code></pre></div>
<p>where the <code>PG:</code> string indicates this concerns the PostGIS driver, followed by database name, and possibly port and user credentials. When the <code>layer</code> and <code>driver</code> arguments are not specified, <code>st_read</code> tries to guess them from the datasource, or else simply reads the first layer, giving a warning in case there are more.</p>
<p><code>st_read</code> typically reads the coordinate reference system as <code>proj4string</code>, but not the EPSG (SRID). GDAL cannot retrieve SRID (EPSG code) from <code>proj4string</code> strings, and, when needed, it has to be set by the user. See also the section on <a href="crs" class="uri">crs</a>.</p>
<p><code><a href="../reference/st_drivers.html">st_drivers()</a></code> returns a <code>data.frame</code> listing available drivers, and their metadata: names, whether a driver can write, and whether it is a raster and/or vector driver. All drivers can read. Reading of some common data formats is illustrated below:</p>
<p><code><a href="../reference/st_layers.html">st_layers(dsn)</a></code> lists the layers present in data source <code>dsn</code>, and gives the number of fields, features and geometry type for each layer:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/st_layers.html">st_layers</a></span>(<span class="kw">system.file</span>(<span class="st">"osm/overpass.osm"</span>, <span class="dt">package=</span><span class="st">"sf"</span>))
## Driver: OSM 
## Available layers:
##         layer_name       geometry_type features fields
## 1           points               Point       NA     10
## 2            lines         Line String       NA      9
## 3 multilinestrings   Multi Line String       NA      4
## 4    multipolygons       Multi Polygon       NA     25
## 5  other_relations Geometry Collection       NA      4</code></pre></div>
<p>we see that in this case, the number of features is <code>NA</code> because for this xml file the whole file needs to be read, which may be costly for large files. We can force counting by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">Sys.setenv</span>(<span class="dt">OSM_USE_CUSTOM_INDEXING=</span><span class="st">"NO"</span>)
<span class="kw"><a href="../reference/st_layers.html">st_layers</a></span>(<span class="kw">system.file</span>(<span class="st">"osm/overpass.osm"</span>, <span class="dt">package=</span><span class="st">"sf"</span>), <span class="dt">do_count =</span> <span class="ot">TRUE</span>)
## Driver: OSM 
## Available layers:
##         layer_name       geometry_type features fields
## 1           points               Point        1     10
## 2            lines         Line String        0      9
## 3 multilinestrings   Multi Line String        0      4
## 4    multipolygons       Multi Polygon       13     25
## 5  other_relations Geometry Collection        0      4</code></pre></div>
<p>Another example of reading kml and kmz files is:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Download .shp data</span>
u_shp &lt;-<span class="st"> "http://coagisweb.cabq.gov/datadownload/biketrails.zip"</span>
<span class="kw">download.file</span>(u_shp, <span class="st">"biketrails.zip"</span>)
<span class="kw">unzip</span>(<span class="st">"biketrails.zip"</span>)
u_kmz &lt;-<span class="st"> "http://coagisweb.cabq.gov/datadownload/BikePaths.kmz"</span>
<span class="kw">download.file</span>(u_kmz, <span class="st">"BikePaths.kmz"</span>)
<span class="co"># Read file formats</span>
biketrails_shp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"biketrails.shp"</span>)
if(<span class="kw">Sys.info</span>()[<span class="dv">1</span>] ==<span class="st"> "Linux"</span>) <span class="co"># may not work if not Linux</span>
  biketrails_kmz &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"BikePaths.kmz"</span>)
u_kml =<span class="st"> "http://www.northeastraces.com/oxonraces.com/nearme/safe/6.kml"</span>
<span class="kw">download.file</span>(u_kml, <span class="st">"bikeraces.kml"</span>)
bikraces &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"bikeraces.kml"</span>)</code></pre></div>
</div>
<div id="crud" class="section level3">
<h3 class="hasAnchor">
<a href="#crud" class="anchor"></a>Create, read, update and delete</h3>
<p>GDAL provides the <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">crud</a> (create, read, update, delete) functions to persistent storage. <code>st_read</code> (or <code>read_sf</code>) are used for reading. <code>st_write</code> (or <code>write_sf</code>) creates, and has the following arguments to control update and delete:</p>
<ul>
<li>
<code>update=TRUE</code> causes an existing data source to be updated, if it exists; this options is by default <code>TRUE</code> for all database drivers, where the database is updated by adding a table.</li>
<li>
<code>delete_layer=TRUE</code> causes <code>st_write</code> try to open the the data source and delete the layer; no errors are given if the data source is not present, or the layer does not exist in the data source.</li>
<li>
<code>delete_dsn=TRUE</code> causes <code>st_write</code> to delete the data source when present, before writing the layer in a newly created data source. No error is given when the data source does not exist. This option should be handled with care, as it may wipe complete directories or databases.</li>
</ul>
</div>
<div id="benchmarks" class="section level3">
<h3 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h3>
<p>Benchmarks show that <code><a href="../reference/st_read.html">st_read()</a></code> is faster than <code>rgdal::readOGR()</code>, for example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">shp_read_sp &lt;-<span class="st"> </span>function() rgdal::<span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">"."</span>, <span class="dt">layer =</span> <span class="st">"biketrails"</span>)
shp_read_sf &lt;-<span class="st"> </span>function() <span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"biketrails.shp"</span>)
if(<span class="kw">Sys.info</span>()[<span class="dv">1</span>] ==<span class="st"> "Linux"</span>) {
  kmz_read_sp &lt;-<span class="st"> </span>function() rgdal::<span class="kw">readOGR</span>(<span class="dt">dsn =</span> <span class="st">"BikePaths.kmz"</span>)
  kmz_read_sf &lt;-<span class="st"> </span>function() <span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"BikePaths.kmz"</span>)
} else {
    kmz_read_sp &lt;-<span class="st"> </span>function() <span class="kw">message</span>(<span class="st">"NA"</span>)
    kmz_read_sf &lt;-<span class="st"> </span>function() <span class="kw">message</span>(<span class="st">"NA"</span>)
}
kml_read_sp &lt;-<span class="st"> </span>function() rgdal::<span class="kw">readOGR</span>(<span class="st">"bikeraces.kml"</span>)
kml_read_sf &lt;-<span class="st"> </span>function() <span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="st">"bikeraces.kml"</span>)
microbenchmark::<span class="kw">microbenchmark</span>(<span class="kw">shp_read_sp</span>(), <span class="kw">shp_read_sf</span>(),
                               <span class="kw">kmz_read_sp</span>(), <span class="kw">kmz_read_sf</span>(),
                               <span class="kw">kml_read_sp</span>(), <span class="kw">kml_read_sf</span>(), <span class="dt">times =</span> <span class="dv">10</span>)</code></pre></div>
<p>On a laptop with an Intel i5-4300M CPU @ 2.60GHz with ssd the results were as follows:</p>
<pre><code>Unit: milliseconds
          expr         min          lq       mean     median          uq
 shp_read_sp() 4993.954530 5010.798950 5072.94155 5049.68057 5116.050416
 shp_read_sf()  331.580349  341.608044  352.99233  353.00169  364.601151
 kmz_read_sp() 4940.108931 4966.177983 5021.47680 4989.82589 5038.393259
 kmz_read_sf() 1086.925988 1088.850196 1103.04846 1090.15794 1100.518670
 kml_read_sp()  167.556454  176.395750  182.10324  185.31941  187.720235
 kml_read_sf()    8.132629    8.268952   10.44328    8.52626    9.420043
        max neval   cld
 5186.16240    10     e
  376.64045    10   c  
 5282.25874    10     e
 1178.42358    10    d 
  189.29191    10  b   
   26.20221    10 a    </code></pre>
<p>This shows that <code>sf::st_read()</code> is substantially faster than <code>rgdal::readOGR()</code>: by a factor of 14-18 for the Shapefile and KML files, and more than a factor of 4 for the KMZ file used in this benchmark, respectively.</p>
</div>
<div id="directly-reading-and-writing-to-spatial-databases" class="section level3">
<h3 class="hasAnchor">
<a href="#directly-reading-and-writing-to-spatial-databases" class="anchor"></a>Directly reading and writing to spatial databases</h3>
<p>Two further functions, <code>st_read_db</code> and <code>st_write_db</code> attempt to read and write from spatial databases, directly reading WKB or WKT without using GDAL. The advantage over <code>st_read</code> may be that instead of a complete table, the result of a (spatial) query may be fetched, limiting the amount of data that is read into R, and potentially benefiting from the spatial index of the database. Although intended to use the DBI interface, current use and testing of these functions are limited to PostGIS.</p>
</div>
</div>
<div id="crs" class="section level2">
<h2 class="hasAnchor">
<a href="#crs" class="anchor"></a>Coordinate reference systems and transformations</h2>
<p>Coordinate reference systems (CRS) are like measurement units for coordinates: they specify which location on Earth a particular coordinate pair refers to. We saw above that <code>sfc</code> objects (geometry list-columns) have two attributes to store a CRS: <code>epsg</code> and <code>proj4string</code>. This implies that all geometries in a geometry list-column must have the same CRS. Both may be <code>NA</code>, e.g. in case the CRS is unknown, or when we work with local coordinate systems (e.g. inside a building, a body, or an abstract space).</p>
<p><code>proj4string</code> is a generic, string-based description of a CRS, understood by the <a href="http://proj4.org/">PROJ.4</a> library. It defines projection types and (often) defines parameter values for particular projections, and hence can cover an infinite amount of different projections. This library (also used by GDAL) provides functions to convert or transform between different CRS. <code>epsg</code> is the integer ID for a particular, known CRS that can be resolved into a <code>proj4string</code>. There is no (known, simple and general) way to resolve <code>proj4string</code> values into <code>epsg</code> IDs.</p>
<p>The importance of having <code>epsg</code> values stored with data besides <code>proj4string</code> values is that the <code>epsg</code> refers to particular, well-known CRS, whose parameters may change (improve) over time; fixing only the <code>proj4string</code> may remove the possibility to benefit from such improvements, and limit the provenance of datasets.</p>
<p>Coordinate reference system transformations can be carried out using <code>st_transform</code>, e.g. converting longitudes/latitudes in NAD27 to web mercator (EPSG:3857) can be done by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc.web_mercator &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_transform.html">st_transform</a></span>(nc, <span class="dv">3857</span>)
<span class="kw"><a href="../reference/st_geometry.html">st_geometry</a></span>(nc.web_mercator)[[<span class="dv">4</span>]][[<span class="dv">2</span>]][[<span class="dv">1</span>]][<span class="dv">1</span>:<span class="dv">3</span>,]
##          [,1]    [,2]
## [1,] -8463267 4377519
## [2,] -8460094 4377510
## [3,] -8450437 4375553</code></pre></div>
</div>
<div id="conversion-including-to-and-from-sp" class="section level2">
<h2 class="hasAnchor">
<a href="#conversion-including-to-and-from-sp" class="anchor"></a>Conversion, including to and from sp</h2>
<p><code>sf</code> objects and objects deriving from <code>Spatial</code> (package <code>sp</code>) can be coerced both ways:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">showMethods</span>(<span class="st">"coerce"</span>, <span class="dt">classes =</span> <span class="st">"sf"</span>)
## Function: coerce (package methods)
## from="sf", to="Spatial"
## from="Spatial", to="sf"
<span class="kw">methods</span>(st_as_sf)
## [1] st_as_sf.data.frame* st_as_sf.map*        st_as_sf.sf*        
## [4] st_as_sf.Spatial*   
## see '?methods' for accessing help and source code
<span class="kw">methods</span>(st_as_sfc)
##  [1] st_as_sfc.character*          st_as_sfc.factor*            
##  [3] st_as_sfc.list*               st_as_sfc.map*               
##  [5] st_as_sfc.SpatialLines*       st_as_sfc.SpatialMultiPoints*
##  [7] st_as_sfc.SpatialPixels*      st_as_sfc.SpatialPoints*     
##  [9] st_as_sfc.SpatialPolygons*    st_as_sfc.WKB*               
## see '?methods' for accessing help and source code
<span class="co"># anticipate that sp::CRS will expand proj4strings:</span>
p4s &lt;-<span class="st"> "+proj=longlat +datum=NAD27 +no_defs +ellps=clrk66 +nadgrids=@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat"</span>
<span class="kw"><a href="../reference/st_crs.html">st_crs</a></span>(nc) &lt;-<span class="st"> </span>p4s
## Warning: st_crs&lt;- : replacing crs does not reproject data; use st_transform
## for that
<span class="co"># anticipate geometry column name changes:</span>
<span class="kw">names</span>(nc)[<span class="dv">15</span>] =<span class="st"> "geometry"</span>
<span class="kw">attr</span>(nc, <span class="st">"sf_column"</span>) =<span class="st"> "geometry"</span>
nc.sp &lt;-<span class="st"> </span><span class="kw">as</span>(nc, <span class="st">"Spatial"</span>)
<span class="kw">class</span>(nc.sp)
## [1] "SpatialPolygonsDataFrame"
## attr(,"package")
## [1] "sp"
nc2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_as_sf.html">st_as_sf</a></span>(nc.sp)
<span class="kw">all.equal</span>(nc, nc2)
## [1] "Component \"geometry\": Attributes: &lt; Component \"crs\": Component \"epsg\": 'is.NA' value mismatch: 1 in current 0 in target &gt;"</code></pre></div>
<p>As the <code>Spatial*</code> objects only support <code>MULTILINESTRING</code> and <code>MULTIPOLYGON</code>, <code>LINESTRING</code> and <code>POLYGON</code> geometries are automatically coerced into their <code>MULTI</code> form. When converting <code>Spatial*</code> into <code>sf</code>, if all geometries consist of a single <code>POLYGON</code> (possibly with holes), a <code>POLYGON</code> and otherwise all geometries are returned as <code>MULTIPOLYGON</code>: a mix of <code>POLYGON</code> and <code>MULTIPOLYGON</code> (such as common in shapefiles) is not created. Argument <code>forceMulti=TRUE</code> will override this, and create <code>MULTIPOLYGON</code>s in all cases. For <code>LINES</code> the situation is identical.</p>
</div>
<div id="geometrycollection" class="section level2">
<h2 class="hasAnchor">
<a href="#geometrycollection" class="anchor"></a>Geometrical operations</h2>
<p>The standard for simple feature access defines a number of geometrical operations.</p>
<p><code>st_is_valid</code> and <code>st_is_simple</code> return a boolean indicating whether a geometry is valid or simple.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/valid.html">st_is_valid</a></span>(nc[<span class="dv">1</span>:<span class="dv">2</span>,])
## [1] TRUE TRUE</code></pre></div>
<p><code>st_distance</code> returns a dense numeric matrix with distances between geometries. <code>st_relate</code> returns a character matrix with the <a href="https://en.wikipedia.org/wiki/DE-9IM#Illustration">DE9-IM</a> values for each pair of geometries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x =<span class="st"> </span><span class="kw"><a href="../reference/st_transform.html">st_transform</a></span>(nc, <span class="dv">32119</span>)
<span class="kw"><a href="../reference/geos.html">st_distance</a></span>(x[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">22</span>),], x[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">33</span>,<span class="dv">55</span>,<span class="dv">56</span>),])
## Units: m
##           [,1]     [,2]      [,3]     [,4]
## [1,]      0.00 312184.9 128341.85 475623.3
## [2,] 440561.15 114939.7 590434.80      0.0
## [3,]  18944.03 352719.1  78756.89 517527.8
<span class="kw"><a href="../reference/geos.html">st_relate</a></span>(nc[<span class="dv">1</span>:<span class="dv">5</span>,], nc[<span class="dv">1</span>:<span class="dv">4</span>,])
## although coordinates are longitude/latitude, it is assumed that they are planar
##      [,1]        [,2]        [,3]        [,4]       
## [1,] "2FFF1FFF2" "FF2F11212" "FF2FF1212" "FF2FF1212"
## [2,] "FF2F11212" "2FFF1FFF2" "FF2F11212" "FF2FF1212"
## [3,] "FF2FF1212" "FF2F11212" "2FFF1FFF2" "FF2FF1212"
## [4,] "FF2FF1212" "FF2FF1212" "FF2FF1212" "2FFF1FFF2"
## [5,] "FF2FF1212" "FF2FF1212" "FF2FF1212" "FF2FF1212"</code></pre></div>
<p>The commands <code>st_intersects</code>, <code>st_disjoint</code>, <code>st_touches</code>, <code>st_crosses</code>, <code>st_within</code>, <code>st_contains</code>, <code>st_overlaps</code>, <code>st_equals</code>, <code>st_covers</code>, <code>st_covered_by</code>, <code>st_equals_exact</code> and <code>st_is_within_distance</code> return a sparse matrix with matching (TRUE) indexes, or a full logical matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/geos.html">st_intersects</a></span>(nc[<span class="dv">1</span>:<span class="dv">5</span>,], nc[<span class="dv">1</span>:<span class="dv">4</span>,])
## although coordinates are longitude/latitude, it is assumed that they are planar
## [[1]]
## [1] 1 2
## 
## [[2]]
## [1] 1 2 3
## 
## [[3]]
## [1] 2 3
## 
## [[4]]
## [1] 4
## 
## [[5]]
## integer(0)
<span class="kw"><a href="../reference/geos.html">st_intersects</a></span>(nc[<span class="dv">1</span>:<span class="dv">5</span>,], nc[<span class="dv">1</span>:<span class="dv">4</span>,], <span class="dt">sparse =</span> <span class="ot">FALSE</span>)
## although coordinates are longitude/latitude, it is assumed that they are planar
##       [,1]  [,2]  [,3]  [,4]
## [1,]  TRUE  TRUE FALSE FALSE
## [2,]  TRUE  TRUE  TRUE FALSE
## [3,] FALSE  TRUE  TRUE FALSE
## [4,] FALSE FALSE FALSE  TRUE
## [5,] FALSE FALSE FALSE FALSE</code></pre></div>
<p>The commands <code>st_buffer</code>, <code>st_boundary</code>, <code>st_convexhull</code>, <code>st_union_cascaded</code>, <code>st_simplify</code>, <code>st_triangulate</code>, <code>st_polygonize</code>, <code>st_centroid</code>, <code>st_segmentize</code>, and <code>st_union</code> return new geometries, e.g.:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sel &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">14</span>)
geom =<span class="st"> </span><span class="kw"><a href="../reference/st_geometry.html">st_geometry</a></span>(nc.web_mercator[sel,])
buf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/geos.html">st_buffer</a></span>(geom, <span class="dt">dist =</span> <span class="dv">30000</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(buf, <span class="dt">border =</span> <span class="st">'red'</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(geom, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(<span class="kw"><a href="../reference/geos.html">st_buffer</a></span>(geom, -<span class="dv">5000</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">'blue'</span>)</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-41-1.png" width="672"></p>
<p>Commands <code>st_intersection</code>, <code>st_union</code>, <code>st_difference</code>, <code>st_sym_difference</code> return new geometries that are a function of pairs of geometries:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">4</span>))
u &lt;-<span class="st"> </span><span class="kw"><a href="../reference/geos.html">st_union</a></span>(nc)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(u)</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-42-1.png" width="672"></p>
<p>The following code shows how computing an intersection between two polygons may yield a <code>GEOMETRYCOLLECTION</code> with a point, line and polygon:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))
a &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_polygon</a></span>(<span class="kw">list</span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">7.5</span>,<span class="fl">7.5</span>,<span class="dv">0</span>),<span class="kw">c</span>(<span class="dv">0</span>,-<span class="dv">1</span>,-<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))))
b &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_polygon</a></span>(<span class="kw">list</span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">7</span>,<span class="dv">0</span>),<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">0</span>,.<span class="dv">5</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="fl">0.5</span>,-<span class="fl">0.5</span>,-<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">1</span>))))
<span class="kw"><a href="../reference/plot.html">plot</a></span>(a, <span class="dt">ylim =</span> <span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">title</span>(<span class="st">"intersecting two polygons:"</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(b, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">'red'</span>)
(i &lt;-<span class="st"> </span><span class="kw"><a href="../reference/geos.html">st_intersection</a></span>(a,b))
## GEOMETRYCOLLECTION(POINT(1 0), LINESTRING(4 0, 3 0), POLYGON((5.5 0, 7 0, 7 -0.5, 6 -0.5, 5.5 0)))
<span class="kw"><a href="../reference/plot.html">plot</a></span>(a, <span class="dt">ylim =</span> <span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">1</span>))
<span class="kw">title</span>(<span class="st">"GEOMETRYCOLLECTION"</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(b, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">border =</span> <span class="st">'red'</span>)
<span class="kw"><a href="../reference/plot.html">plot</a></span>(i, <span class="dt">add =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">'green'</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-43-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(opar)</code></pre></div>
</div>
<div id="non-valid-geometries" class="section level2">
<h2 class="hasAnchor">
<a href="#non-valid-geometries" class="anchor"></a>Non-valid geometries</h2>
<p>Invalid geometries are for instance self-intersecting lines (left) or polygons with slivers (middle) or self-intersections (right).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(sf)
x1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_linestring</a></span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>)))
x2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_polygon</a></span>(<span class="kw">list</span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.6</span>,<span class="dv">1</span>,<span class="dv">0</span>))))
x3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st.html">st_polygon</a></span>(<span class="kw">list</span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>),<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))))
<span class="kw"><a href="../reference/geos.html">st_is_simple</a></span>(<span class="kw"><a href="../reference/sfc.html">st_sfc</a></span>(x1))
## [1] FALSE
<span class="kw"><a href="../reference/valid.html">st_is_valid</a></span>(<span class="kw"><a href="../reference/sfc.html">st_sfc</a></span>(x2,x3))
## Warning in evalq((function (..., call. = TRUE, immediate. =
## FALSE, noBreaks. = FALSE, : Self-intersection at or near point 1
## 0.59999999999999998
## Warning in evalq((function (..., call. = TRUE, immediate. = FALSE,
## noBreaks. = FALSE, : Self-intersection at or near point 0.5 0.5
## [1] FALSE FALSE</code></pre></div>
<p><img src="sf1_files/figure-html/unnamed-chunk-45-1.png" width="672"></p>
</div>
</div>
<div id="how-attributes-relate-to-geometries" class="section level1">
<h1 class="hasAnchor">
<a href="#how-attributes-relate-to-geometries" class="anchor"></a>How attributes relate to geometries</h1>
<p>(This will eventually be the topic of a new vignette; now here to explain the last attribute of <code>sf</code> objects)</p>
<p>The standard documents about simple features are very detailed about the geometric aspects of features, but say nearly nothing about attributes, except that their values should be understood in another reference system (their <a href="https://CRAN.R-project.org/package=units">units of measurement</a>). But there is more to it. For variables like air temperature, interpolation makes usually sense, for others like human body temperature it doesn’t. The difference is that air temperature is a field, which continues between sensors, where body temperature is an object property that doesn’t extend beyond the body – in spatial statistics bodies would be called a point pattern, their temperature the point marks. For geometries that have a non-zero size (positive length or area), attribute values may refer to the every sub-geometry (every point), or may summarize the geometry. For example, a state’s population density summarizes the whole state, and is not a meaningful estimate of population density for a give point inside the state without the context of the state. On the other hand, land use or geological maps give polygons with constant land use or geology, every point inside the polygon is of that class. Some properties are spatially <a href="https://en.wikipedia.org/wiki/Intensive_and_extensive_properties">extensive</a>, meaning that attributes would summed up when two geometries are merged: population is an example. Other properties are spatially intensive, and should be averaged, with population density the example.</p>
<p>Simple feature objects of class <code>sf</code> have an <em>agr</em> attribute that points to the <em>attribute-geometry-relationship</em>, how attributes relate to their geometry. It can be defined at creation time:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_read.html">st_read</a></span>(<span class="kw">system.file</span>(<span class="st">"shape/nc.shp"</span>, <span class="dt">package=</span><span class="st">"sf"</span>),
    <span class="dt">agr =</span> <span class="kw">c</span>(<span class="dt">AREA =</span> <span class="st">"aggregate"</span>, <span class="dt">PERIMETER =</span> <span class="st">"aggregate"</span>, <span class="dt">CNTY_ =</span> <span class="st">"identity"</span>,
        <span class="dt">CNTY_ID =</span> <span class="st">"identity"</span>, <span class="dt">NAME =</span> <span class="st">"identity"</span>, <span class="dt">FIPS =</span> <span class="st">"identity"</span>, <span class="dt">FIPSNO =</span> <span class="st">"identity"</span>,
        <span class="dt">CRESS_ID =</span> <span class="st">"identity"</span>, <span class="dt">BIR74 =</span> <span class="st">"aggregate"</span>, <span class="dt">SID74 =</span> <span class="st">"aggregate"</span>, <span class="dt">NWBIR74 =</span> <span class="st">"aggregate"</span>,
        <span class="dt">BIR79 =</span> <span class="st">"aggregate"</span>, <span class="dt">SID79 =</span> <span class="st">"aggregate"</span>, <span class="dt">NWBIR79 =</span> <span class="st">"aggregate"</span>))
## Reading layer `nc' from data source `/home/edzer/R/x86_64-pc-linux-gnu-library/3.4/sf/shape/nc.shp' using driver `ESRI Shapefile'
## converted into: POLYGON
## Simple feature collection with 100 features and 14 fields
## Attribute-geometry relationship: 0 constant, 8 aggregate, 6 identity
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965
## epsg (SRID):    4267
## proj4string:    +proj=longlat +datum=NAD27 +no_defs
<span class="kw"><a href="../reference/st_agr.html">st_agr</a></span>(nc)
##      AREA PERIMETER     CNTY_   CNTY_ID      NAME      FIPS    FIPSNO 
## aggregate aggregate  identity  identity  identity  identity  identity 
##  CRESS_ID     BIR74     SID74   NWBIR74     BIR79     SID79   NWBIR79 
##  identity aggregate aggregate aggregate aggregate aggregate aggregate 
## Levels: constant aggregate identity
<span class="kw">data</span>(meuse, <span class="dt">package =</span> <span class="st">"sp"</span>)
meuse_sf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/st_as_sf.html">st_as_sf</a></span>(meuse, <span class="dt">coords =</span> <span class="kw">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="dt">crs =</span> <span class="dv">28992</span>, <span class="dt">agr =</span> <span class="st">"constant"</span>)
<span class="kw"><a href="../reference/st_agr.html">st_agr</a></span>(meuse_sf)
##  cadmium   copper     lead     zinc     elev     dist       om    ffreq 
## constant constant constant constant constant constant constant constant 
##     soil     lime  landuse   dist.m 
## constant constant constant constant 
## Levels: constant aggregate identity</code></pre></div>
<p>When not specified, this field is filled with <code>NA</code> values, but if non-<code>NA</code>, it has one of three possibilities</p>
<table style="width:60%;" class="table">
<colgroup>
<col width="11%">
<col width="48%">
</colgroup>
<thead><tr class="header">
<th align="left">value</th>
<th align="left">meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">constant</td>
<td align="left">a variable that has a constant value at every location over a spatial extent; examples: soil type, climate zone, land use</td>
</tr>
<tr class="even">
<td align="left">aggregate</td>
<td align="left">values are summary values (aggregates) over the geometry, e.g. population density, dominant land use</td>
</tr>
<tr class="odd">
<td align="left">identity</td>
<td align="left">values identify the geometry: they refer to (the whole of) this and only this geometry</td>
</tr>
</tbody>
</table>
<p>With this information (still to be done) we can for instance</p>
<ul>
<li>either return missing values or generate warnings when a <em>aggregate</em> value at a point location inside a polygon is retrieved, or</li>
<li>list the implicit assumptions made when retrieving attribute values at points inside a polygon when <code>relation_to_geometry</code> is missing.</li>
<li>decide what to do with attributes when a geometry is split: do nothing in case the attribute is constant, give an error or warning in case it is an aggregate, change the <code>relation_to_geometry</code> to <em>constant</em> in case it was <em>identity</em>.</li>
</ul>
<p>Further reading:</p>
<ol style="list-style-type: decimal">
<li>S. Scheider, B. Gräler, E. Pebesma, C. Stasch, 2016. Modelling spatio-temporal information generation. Int J of Geographic Information Science, 30 (10), 1980-2008. (<a href="http://pebesma.staff.ifgi.de/generativealgebra.pdf">pdf</a>)</li>
<li>Stasch, C., S. Scheider, E. Pebesma, W. Kuhn, 2014. Meaningful Spatial Prediction and Aggregation. Environmental Modelling &amp; Software, 51, (149–165, <a href="http://dx.doi.org/10.1016/j.envsoft.2013.09.006">open access</a>).</li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#what-is-a-feature">What is a feature?</a><ul class="nav nav-pills nav-stacked">
<li><a href="#dimensions">Dimensions</a></li>
      <li><a href="#simple-feature-geometry-types">Simple feature geometry types</a></li>
      <li><a href="#coordinate-reference-system">Coordinate reference system</a></li>
      </ul>
</li>
      <li>
<a href="#how-simple-features-in-r-are-organized">How simple features in R are organized</a><ul class="nav nav-pills nav-stacked">
<li><a href="#sf-objects-with-simple-features">sf: objects with simple features</a></li>
      <li><a href="#sfc-simple-feature-geometry-list-column">sfc: simple feature geometry list-column</a></li>
      <li><a href="#mixed-geometry-types">Mixed geometry types</a></li>
      <li><a href="#sfg-simple-feature-geometry">sfg: simple feature geometry</a></li>
      <li><a href="#wkb">Well-known text, well-known binary, precision</a></li>
      <li><a href="#reading-and-writing">Reading and writing</a></li>
      <li><a href="#crs">Coordinate reference systems and transformations</a></li>
      <li><a href="#conversion-including-to-and-from-sp">Conversion, including to and from sp</a></li>
      <li><a href="#geometrycollection">Geometrical operations</a></li>
      <li><a href="#non-valid-geometries">Non-valid geometries</a></li>
      </ul>
</li>
      <li><a href="#how-attributes-relate-to-geometries">How attributes relate to geometries</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
